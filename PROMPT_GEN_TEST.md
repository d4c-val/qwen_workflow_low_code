# Prompt Gen → Image 参数传递测试清单

## 🎯 核心问题
**修复前：** Prompt Gen 生成的 JSON 对象 `{prompt: "...", negative_prompt: "..."}` 传递给 Image 节点时，两个字段会混在一起或显示为 `[object Object]`

**修复后：** 正向和负向提示词分别正确传递到 Image 节点的两个独立字段

---

## ✅ 测试用例

### 测试 1：完全自动传递（最常用）

**步骤：**
1. 创建工作流：`[Prompt] → [Prompt Gen] → [Image]`
2. Prompt 节点输入：`"一只可爱的猫"`
3. Image 节点的 Prompt 和 Negative Prompt 字段**都留空**
4. 运行工作流

**预期结果：**
- ✅ Image 节点参数传递面板显示 2 个映射
- ✅ 第一个映射：`[Prompt Gen] → [✨ Prompt (正向提示词)]`
  - 显示：`📋 从 JSON 对象自动提取`
  - 上游输出显示完整的正向提示词
- ✅ 第二个映射：`[Prompt Gen] → [🚫 Negative Prompt (负向提示词)]`
  - 显示：`📋 从 JSON 对象自动提取`
  - 上游输出显示完整的负向提示词
- ✅ 生成的图片符合提示词描述

**控制台日志应显示：**
```
[Image] 从 chatForImage 节点获取提示词: {
  prompt: "(自动获取: 一只可爱的猫咪...)",
  negativePrompt: "(自动获取: 模糊，低质量...)"
}
```

---

### 测试 2：Prompt 手动输入，Negative Prompt 自动

**步骤：**
1. 使用测试 1 的工作流
2. 在 Image 节点的 **Prompt** 字段手动输入：`"一只威武的老虎"`
3. **Negative Prompt** 字段留空
4. 运行工作流

**预期结果：**
- ✅ Prompt 映射显示：`✍️ 手动输入优先，上游值被忽略`
- ✅ 显示手动输入的内容：`"一只威武的老虎"`
- ✅ 同时显示上游的 prompt（标记为 "被忽略"）
- ✅ Negative Prompt 映射显示：`📋 从 JSON 对象自动提取`
- ✅ 生成的图片是**老虎**（而不是猫）

**控制台日志应显示：**
```
[Image] 从 chatForImage 节点获取提示词: {
  prompt: "(手动输入: 一只威武的老虎...)",
  negativePrompt: "(自动获取: 模糊，低质量...)"
}
```

---

### 测试 3：两个字段都手动输入

**步骤：**
1. 使用测试 1 的工作流
2. Image 节点 **Prompt** 字段输入：`"一朵红玫瑰"`
3. Image 节点 **Negative Prompt** 字段输入：`"枯萎，黑白"`
4. 运行工作流

**预期结果：**
- ✅ 两个映射都显示：`✍️ 手动输入优先，上游值被忽略`
- ✅ 分别显示两个手动输入的内容
- ✅ 生成的图片是**玫瑰**，没有枯萎和黑白效果

**控制台日志应显示：**
```
[Image] 从 chatForImage 节点获取提示词: {
  prompt: "(手动输入: 一朵红玫瑰...)",
  negativePrompt: "(手动输入: 枯萎，黑白...)"
}
```

---

### 测试 4：调试模式单步查看

**步骤：**
1. 使用测试 1 的工作流
2. 点击 TopBar 的 `🐛 调试` 按钮开启调试模式
3. 点击 `▶ 运行`
4. 观察执行流程

**预期结果：**

**阶段 1：Prompt 节点执行**
- ✅ 节点变为 `🟢 运行中`
- ✅ 瞬间完成，节点变为 `✅ 已完成`
- ✅ 输出区显示：`"一只可爱的猫"`

**阶段 2：Prompt Gen 节点执行**
- ✅ 节点变为 `🟢 运行中`
- ✅ 等待 AI 生成（几秒钟）
- ✅ 完成后自动暂停，显示 `⏸️ 已暂停 - 等待下一步`
- ✅ 双击 Prompt Gen 节点，查看 NodeDebugPanel
- ✅ 输出区显示 JSON 对象：
  ```json
  {
    "prompt": "一只可爱的橘色小猫，毛茸茸的...",
    "negative_prompt": "模糊，低质量，变形..."
  }
  ```

**阶段 3：Image 节点执行**
- ✅ 点击 `⏭ 下一步` 继续执行
- ✅ Image 节点变为 `🟢 运行中`
- ✅ 查看 Image 节点的参数传递面板
- ✅ 显示 2 个参数映射，都标记为 `📋 从 JSON 对象自动提取`
- ✅ 等待图片生成完成
- ✅ 双击 Image 节点查看 NodeDebugPanel
- ✅ 输入显示两个字段的内容
- ✅ 输出显示图片 URL

---

### 测试 5：没有 Prompt Gen 的情况（兼容性测试）

**步骤：**
1. 创建工作流：`[Prompt] → [Image]`（直接连接，没有 Prompt Gen）
2. Prompt 节点输入：`"一只狗"`
3. 运行工作流

**预期结果：**
- ✅ 仍然能正常工作
- ✅ Image 节点使用常规的变量替换逻辑
- ✅ Prompt 字段显示：`{{node_xxx}}` → `"一只狗"`
- ✅ 生成的图片是狗

**控制台日志应显示：**
```
[Image] 使用常规提示词: { prompt: "一只狗", negativePrompt: "" }
```

---

## 🔍 检查要点

### 1. 参数传递面板
- [ ] 显示 `🔗 参数传递 (2)`
- [ ] 两个映射分别显示 Prompt 和 Negative Prompt
- [ ] 图标正确：`📋`（自动）或 `✍️`（手动）
- [ ] 文字正确：`从 JSON 对象自动提取` 或 `手动输入优先，上游值被忽略`

### 2. 节点样式
- [ ] 已执行的节点有绿色边框
- [ ] 错误节点有红色边框
- [ ] 调试暂停时节点有黄色边框

### 3. 控制台日志
- [ ] 显示 `[Image] 从 chatForImage 节点获取提示词:`
- [ ] 日志中包含正确的 prompt 和 negativePrompt 值
- [ ] 手动输入时显示 "(手动输入: ...)"
- [ ] 自动获取时显示 "(自动获取: ...)"

### 4. NodeDebugPanel
- [ ] 双击节点能打开调试面板
- [ ] 输入区显示所有参数
- [ ] 输出区显示结果
- [ ] JSON 对象格式化显示正确

### 5. 生成结果
- [ ] 图片符合提示词描述
- [ ] 图片没有负向提示词中的元素
- [ ] 手动输入优先级正确

---

## 🐛 常见问题排查

### 问题 1：参数传递面板不显示或只显示 1 个映射
**可能原因：**
- Prompt Gen 没有成功执行
- Prompt Gen 返回的不是 JSON 对象
- 节点连接关系不正确

**排查步骤：**
1. 开启调试模式，单步执行
2. 双击 Prompt Gen 查看输出
3. 确认输出是 JSON 对象格式
4. 检查节点连接线是否正确

### 问题 2：显示 "[object Object]"
**可能原因：**
- 代码更新没有生效
- Docker 镜像没有重新构建

**解决方法：**
```bash
cd /Users/smzdm/workforzdm/qwen_node
docker compose down
docker compose build
docker compose up -d
```

### 问题 3：手动输入不生效
**可能原因：**
- 字段中可能包含空格或特殊字符
- 包含了 `{{}}` 模板语法

**解决方法：**
- 确保输入的是纯文本
- 删除所有模板引用

### 问题 4：Negative Prompt 为空
**可能原因：**
- Prompt Gen 没有生成 negative_prompt 字段
- AI 模型输出格式不正确

**排查步骤：**
1. 双击 Prompt Gen 查看原始输出
2. 检查 JSON 中是否包含 `negative_prompt` 字段
3. 如果没有，检查 Prompt Gen 的 system prompt 设置

---

## 📊 测试结果记录

| 测试用例 | 日期 | 结果 | 备注 |
|---------|------|------|------|
| 测试 1：完全自动 | 2026-01-09 | ✅ 通过 | |
| 测试 2：部分手动 | 2026-01-09 | ✅ 通过 | |
| 测试 3：完全手动 | 2026-01-09 | ✅ 通过 | |
| 测试 4：调试模式 | 2026-01-09 | ✅ 通过 | |
| 测试 5：兼容性 | 2026-01-09 | ✅ 通过 | |

---

## 🎉 验收标准

修复被认为成功当且仅当：
- ✅ 所有 5 个测试用例都通过
- ✅ 控制台日志正确显示参数信息
- ✅ 参数传递面板正确显示 2 个独立映射
- ✅ 生成的图片符合预期
- ✅ 手动输入能够正确覆盖上游值
- ✅ 不影响其他节点的正常工作（兼容性）

---

**文档创建日期：** 2026-01-09  
**最后更新：** 2026-01-09  
**测试状态：** ✅ 所有测试通过