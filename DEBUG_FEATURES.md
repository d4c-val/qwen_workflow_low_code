# QwenFlow 调试功能更新说明

## 📝 更新日期
2026-01-08

## ✨ 新增功能

### 1. 调试模式（单步执行） 🐛

**功能描述：**
- 开启调试模式后，工作流会在每一层节点执行后自动暂停
- 可以逐层查看执行结果，手动控制执行进度
- 显示当前执行的层级和待执行的节点列表

**使用方法：**
1. 点击顶部工具栏的 "🐛 调试" 按钮开启/关闭调试模式
2. 调试模式开启后，按钮会显示为 "🐛 调试中"
3. 点击 "▶ 运行" 开始执行工作流
4. 工作流执行第一层节点后会自动暂停
5. 点击 "⏭ 下一步" 按钮继续执行下一层
6. 可随时点击 "■ 停止" 取消执行

**界面变化：**
- 调试模式激活时，"🐛 调试" 按钮变为黄色高亮
- 暂停时显示 "⏭ 下一步" 按钮（绿色，带动画）
- 顶部显示进度提示："层 X/Y"，以及待执行节点列表
- 队列面板显示详细的调试状态信息

---

### 2. 节点调试面板 🔍

**功能描述：**
- 双击任意节点打开详细调试面板
- 查看节点的输入、输出和完整配置
- 可单独运行某个节点进行测试

**使用方法：**
1. **双击任意节点** 打开调试面板
2. 面板包含三个选项卡：
   - **📥 输入** - 显示节点配置输入和上游节点的输出
   - **📤 输出** - 显示节点的执行结果（支持图片、视频、文本、JSON）
   - **⚙️ 配置** - 显示节点的完整配置 JSON 数据
3. 点击 "▶ 运行此节点" 可单独执行该节点
4. 点击 ✕ 或面板外部关闭

**显示内容：**
- 节点类型、ID、位置信息
- 上游节点的输入数据
- 节点自身的配置参数
- 执行结果（自动识别图片/视频/文本/JSON）
- 执行状态（空闲/运行中/已完成/错误）

---

### 3. 参数传递可视化 🔗

**功能描述：**
- 在节点中自动显示上游数据的传递情况
- 清晰展示哪些参数来自哪个上游节点
- 显示模板引用和实际替换值

**显示位置：**
- 在每个有上游连接的节点内部
- 位于节点参数输入框上方
- 标题为 "🔗 参数传递 (N)"，默认展开

**显示内容：**
每个映射关系包含：
1. **来源和目标**
   - `[上游节点名称] → [目标参数名称]`
   - 上游节点：蓝色标签
   - 目标参数：绿色标签（显式引用）或黄色标签（自动获取）

2. **模板引用**（如果有显式引用）
   - 显示原始的 `{{node_id}}` 模板语法
   - 黄色高亮显示

3. **传递值**
   - 显示实际传递的数据
   - 图片显示缩略图预览
   - 文本自动截断（超过 100 字符）
   - JSON 格式化显示

4. **状态指示**
   - ✓ **已传递** - 上游节点已执行，数据已传入（绿色）
   - ⏳ **待执行** - 上游节点尚未执行（灰色）

**示例：**
```
🔗 参数传递 (2)

┌─────────────────────────────────────┐
│ [Prompt] → [Prompt] ✓ 已传递        │
│ 模板引用: {{node_1736841234567}}    │
│ 替换结果: 一只可爱的猫咪            │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ [ChatForImage] → [(自动获取)] ⏳ 待执行│
└─────────────────────────────────────┘
```

---

### 4. 历史记录增强 📊

**功能描述：**
- 保存每次执行的所有节点输入输出
- 可以回看历史执行记录
- 支持展开查看每个节点的详细信息

**使用方法：**
1. 点击右侧队列面板，切换到 "历史记录" 标签
2. 列表显示最近 20 条执行记录
3. 每条记录显示：
   - 工作流 ID
   - 执行状态（✅ 成功 / ❌ 错误）
   - 执行时间
   - 耗时（毫秒）
   - 节点数量
4. 点击 "🔍 查看详情" 打开详情面板
5. 点击 "🔄 重跑" 重新执行该工作流

**详情面板内容：**
- 执行概览（ID、状态、时间、耗时、节点数）
- 可展开的节点列表
- 每个节点的：
  - 输入数据（包括上游节点输出和配置参数）
  - 输出结果（支持图片预览）
  - 错误信息（如果有）

---

### 5. 界面优化

**节点悬停提示：**
- 鼠标悬停在节点上时，标题栏右侧显示 "双击调试" 提示

**队列面板增强：**
- 调试模式下显示 "调试" 标签（黄色）
- 当前队列显示更详细的执行信息
- 历史记录卡片添加操作按钮

**顶部工具栏：**
- 调试按钮（蓝色/黄色切换）
- 下一步按钮（调试暂停时显示，绿色带动画）
- 进度指示器（显示当前层级和节点）

---

## 🔧 技术实现

### 前端改动

**新增文件：**
- `qwen-ui/src/components/NodeDebugPanel.jsx` - 节点调试面板和历史记录详情面板

**修改文件：**
- `qwen-ui/src/App.jsx` - 添加调试模式状态和单步执行逻辑
- `qwen-ui/src/components/TopBar.jsx` - 添加调试按钮和步进控制
- `qwen-ui/src/components/QueuePanel.jsx` - 增强历史记录显示
- `qwen-ui/src/components/CustomNodes.jsx` - 添加参数传递显示组件

**核心功能：**
1. **调试状态管理**
   - `debugMode` - 是否开启调试模式
   - `debugPaused` - 是否暂停中
   - `pendingLayers` - 待执行的层级
   - `executionContext` - 执行上下文（节点输出）
   - `currentLayerIndex` - 当前执行到的层级

2. **执行记录保存**
   - `nodeResults` - 每个节点的输出结果
   - `nodeInputs` - 每个节点的输入数据（包括上游输出和配置）
   - 保存到历史记录数组，最多保留 20 条

3. **参数映射分析**
   - 检测节点参数中的 `{{node_id}}` 模板引用
   - 分析上游连接关系
   - 实时计算参数替换结果

### 后端改动

无需改动，所有功能在前端实现。

---

## 📚 使用示例

### 示例 1：调试图像生成流程

1. 创建工作流：
   ```
   [Prompt] → [Prompt Gen] → [Image] → [Debug]
   ```

2. 开启调试模式

3. 执行工作流：
   - 第 1 层：Prompt 执行完成，暂停
   - 查看 Prompt 节点输出
   - 点击下一步
   - 第 2 层：Prompt Gen 执行完成，暂停
   - 双击 Prompt Gen 查看生成的提示词 JSON
   - 点击下一步
   - 第 3 层：Image 执行完成，暂停
   - 在 Image 节点的参数传递面板查看提示词如何传入
   - 点击下一步
   - 第 4 层：Debug 执行完成，工作流结束

### 示例 2：查看历史记录

1. 执行完一个工作流后
2. 打开右侧面板的 "历史记录"
3. 找到刚才的执行记录
4. 点击 "🔍 查看详情"
5. 展开每个节点查看输入输出
6. 确认数据传递是否正确

### 示例 3：单独测试节点

1. 创建一个 Chat 节点
2. 双击打开调试面板
3. 在 Prompt 字段输入测试内容
4. 点击 "▶ 运行此节点"
5. 在 "📤 输出" 选项卡查看结果
6. 满意后再连接到工作流中

---

## 💡 最佳实践

1. **调试复杂工作流**
   - 开启调试模式
   - 逐层检查每个节点的输出
   - 确保数据正确传递到下一层

2. **查看参数传递**
   - 在下游节点的参数传递面板确认数据来源
   - 检查模板引用是否正确
   - 确认替换后的值符合预期

3. **回溯历史执行**
   - 对比不同执行的结果
   - 找出失败的原因
   - 重跑成功的配置

4. **单节点测试**
   - 先单独测试新节点
   - 确认输出格式正确
   - 再集成到完整工作流

---

## 🎯 未来计划

- [ ] 支持断点调试（在指定节点暂停）
- [ ] 支持修改节点输入后重新执行
- [ ] 支持导出/导入调试会话
- [ ] 支持性能分析（节点执行时间统计）
- [ ] 支持数据可视化（图表展示节点关系）

---

## 📝 更新日志

### v2.0.0 (2026-01-08)
- ✨ 新增调试模式（单步执行）
- ✨ 新增节点调试面板
- ✨ 新增参数传递可视化
- ✨ 增强历史记录功能
- ✨ 新增单节点运行功能
- 🎨 优化界面交互
- 📚 更新文档

### v1.0.0 (之前)
- 基础工作流编排功能
- AI 文本/图像/视频生成
- 节点变量引用
- 基础调试节点

---

**感谢使用 QwenFlow！如有问题或建议，欢迎提交 Issue。**
